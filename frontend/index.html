<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kimusho Wholesalers - Home</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
</head>
<body>

<header class="navbar">
    <div class="logo">kimusho<span>w/s</span></div>
    <div class="search-bar">
        <input type="text" placeholder="I am shopping for..." />
        <button><i class="fas fa-search"></i></button>
    </div>
    <nav id="nav-links">
        <a href="#home">Home</a>
        <a href="#about">About Us</a>
        <a href="#contact">Contact Us</a>
        <a href="products.html">Products</a>
        <a href="login.html" class="nav-btn" id="login-link">Login</a>
        <a href="register.html" class="nav-btn outline" id="register-link">Register</a>
    </nav>
</header>

<section id="home" class="section-container">
    <div class="hero-banner">
        <h1>Best Wholesale Prices in Kenya</h1>
        <p>Get the best deals on bulk orders directly from suppliers.</p>
    </div>

    <h2 class="section-title">Today's Deals</h2>
    
    <!-- Replace static product cards with this dynamic container -->
    <div class="product-grid" id="productGrid">
        <!-- Products will be dynamically loaded here -->
    </div>
</section>

<section id="about" class="section-container bg-white">
    <h2 class="section-title">About Us</h2>
    <div class="content-wrapper">
        <p>
            Welcome to <strong>Kimusho Wholesalers</strong>, Kenya's premier B2B platform.
            We bridge the gap between manufacturers and retailers, ensuring you get the best market prices.
        </p>
        <ul style="margin-top: 15px; padding-left: 20px;">
            <li>Next-day delivery across Nairobi.</li>
            <li>Verified quality products.</li>
            <li>Secure payment options (M-Pesa & Card).</li>
        </ul>
    </div>
</section>

<section id="contact" class="section-container">
    <h2 class="section-title">Contact Us</h2>
    <div class="contact-grid">
        <div class="contact-info">
            <h3>Get in Touch</h3>
            <p>üìç Location: Madaraka Estate, Nairobi</p>
            <p>üìû Phone: +254 700 123 456</p>
            <p>üìß Email: support@kimushowholesalers.co.ke</p>
        </div>
        <form class="contact-form">
            <input type="text" placeholder="Your Name" required />
            <input type="email" placeholder="Your Email" required />
            <textarea placeholder="Message" rows="4" required></textarea>
            <button type="submit" class="auth-btn">Send Message</button>
        </form>
    </div>
</section>

<footer>
    <p>&copy; 2026 Kimusho Wholesalers. All rights reserved.</p>
</footer>

<script>
    // 1. AUTHENTICATION HELPERS
    function isLoggedIn() {
        return localStorage.getItem('token') !== null && localStorage.getItem('user') !== null;
    }

    function updateNavbar() {
        const nav = document.getElementById('nav-links');
        if (isLoggedIn()) {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('login-link').remove();
            document.getElementById('register-link').remove();

            const userGreet = document.createElement('span');
            userGreet.innerHTML = `Hi, <strong>${user.username}</strong>`;
            userGreet.style.marginLeft = "15px";

            const logoutBtn = document.createElement('a');
            logoutBtn.href = "#";
            logoutBtn.className = "nav-btn outline";
            logoutBtn.style.marginLeft = "10px";
            logoutBtn.textContent = "Logout";
            logoutBtn.onclick = function () {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.reload();
            };

            nav.appendChild(userGreet);
            nav.appendChild(logoutBtn);
        }
    }

    // 2. DYNAMIC PRODUCTS LOADING
    async function loadProducts() {
        try {
            const res = await fetch('/api/products');
            if (!res.ok) throw new Error('Failed to fetch products');

            const products = await res.json();

            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            products.forEach(p => {
                grid.innerHTML += `
                    <div class="product-card">
                        ${p.is_hot ? '<div class="badge hot">Hot</div>' : ''}
                        ${p.is_sale ? '<div class="badge sale">Sale</div>' : ''}
                        <img src="/uploads/${p.image || 'placeholder.jpg'}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/200'"/>
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            <p class="price">KSh ${Number(p.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                            <button class="add-btn" data-id="${p.id}">Add to Cart</button>
                        </div>
                    </div>
                `;
            });

            // Attach Add to Cart listeners to buttons
            const addBtns = document.querySelectorAll('.add-btn');
            addBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const productId = this.getAttribute('data-id');
                    if (addToCart(productId)) {
                        const originalText = this.textContent;
                        this.textContent = "Added!";
                        this.style.background = "#28a745"; // Success green
                        setTimeout(() => {
                            this.textContent = originalText;
                            this.style.background = ""; // Back to CSS default
                        }, 1000);
                    }
                });
            });

        } catch (error) {
            console.error(error);
            document.getElementById('productGrid').innerHTML = '<p>Failed to load products.</p>';
        }
    }

    // 3. CART LOGIC
    const productsCache = []; // Optional: cache for products if needed

    function addToCart(productId) {
        if (!isLoggedIn()) {
            alert("You must Login or Register to add items to your cart!");
            window.location.href = "login.html";
            return false;
        }

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        const product = productsCache.find(p => p.id == productId) || null;

        // Since productsCache might be empty, you can also fallback to simple minimal product info:
        // But better to keep product info in the button dataset or load beforehand

        if (!product) {
            alert("Product info not found.");
            return false;
        }

        const existing = cart.find(item => item.id == productId);

        if (existing) {
            existing.qty += 1;
        } else {
            cart.push({ ...product, qty: 1 });
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        return true;
    }

    // 4. INIT
    document.addEventListener('DOMContentLoaded', function () {
        updateNavbar();
        loadProducts();
    });

</script>
</body>
</html>
